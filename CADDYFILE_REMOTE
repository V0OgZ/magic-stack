heroesoftime.online {
	encode zstd gzip

	@cors_preflight method OPTIONS
	handle @cors_preflight {
		header Access-Control-Allow-Origin "*"
		header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "*"
		respond 204
	}

	# Backends
	handle_path /api/* {
		reverse_proxy http://127.0.0.1:8082
	}
	handle_path /engine/* {
		reverse_proxy http://127.0.0.1:3001
	}
	handle_path /vector/* {
		reverse_proxy http://127.0.0.1:7500
	}
	handle_path /clippy/* {
		reverse_proxy http://127.0.0.1:7777
	}
	handle_path /mcp/* {
		reverse_proxy http://127.0.0.1:9000
	}
	handle_path /swagger-ui/* {
		reverse_proxy http://127.0.0.1:8082
	}

        # FRONTPAGE assets (MUST BE BEFORE /assets/*)
        handle /FRONTPAGE/assets/* {
                root * /opt/hot/app
                file_server
        }

	# SPA static assets (Vite build)
	handle /assets/* {
		root * /opt/hot/app/apps/magic-stack-unified/dist
		file_server
	}
	handle /vite.svg {
		root * /opt/hot/app/apps/magic-stack-unified/dist
		file_server
	}

	# React SPA
	@spa path /game* /unified* /world-builder*
	handle @spa {
		root * /opt/hot/app/apps/magic-stack-unified/dist
		try_files {path} /index.html
		file_server
	}

	# World Editor React (3-in-1)
	handle /world-editor/* {
		root * /opt/hot/app/apps/world-editor/dist
		try_files {path} /index.html
		file_server
	}

	# HTML utilities (catch-all + fallback)
	handle /api-explorer {
		root * /opt/hot/app
                rewrite * /API_EXPLORER_COMPLETE.html
                file_server
	}
	handle /vector-ui {
		root * /opt/hot/app
                rewrite * /VECTOR_DB_EXPLORER_UI.html
                file_server
	}
	# Serve root-level HTML via /html/* with extension fallback
	handle_path /html/* {
		root * /opt/hot/app
		try_files {path} {path}.html /HTML_INDEX.html
		file_server
	}

	# Serve FRONTPAGE directory explicitly (HTML + assets)
	handle /FRONTPAGE/* {
		root * /opt/hot/app
		file_server
	}

	# Serve experimental dashboard at root
	handle /HTML_INDEX.html {
		root * /opt/hot/app
		file_server
	}

	# Serve the new front page locally (no external redirect)
	handle / {
		root * /opt/hot/app/FRONTPAGE
		file_server
	}

	# Custom 404 page from FRONTPAGE/404.html
	handle_errors {
		@notfound expression {http.error.status_code} == 404
		handle @notfound {
			root * /opt/hot/app/FRONTPAGE
			rewrite * /404.html
			file_server
		}
	}
}
