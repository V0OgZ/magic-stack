#!/bin/bash

# 🚀 DEPLOY - Script de déploiement unifié
# Un seul script pour tout déployer proprement

# Couleurs
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
SSH_KEY="~/.ssh/hot_magic_key"
VPS_HOST="root@191.101.2.178"
VPS_URL="heroesoftime.online"
VPS_APP_DIR="/opt/hot/app"

# ═══════════════════════════════════════════
# FONCTIONS HELPER
# ═══════════════════════════════════════════

show_usage() {
    echo -e "${CYAN}🚀 DEPLOY - Script de déploiement unifié${NC}"
    echo ""
    echo "Usage: ./deploy [command]"
    echo ""
    echo "Commands:"
    echo "  local     - Déployer en local seulement"
    echo "  vps       - Déployer sur le VPS (rapide)"
    echo "  full      - Build + deploy complet"
    echo "  health    - Vérifier santé du VPS"
    echo "  backup    - Sauvegarder avant deploy"
    echo "  help      - Afficher cette aide"
    echo ""
    echo "Exemples:"
    echo "  ./deploy vps      # Deploy rapide sur VPS"
    echo "  ./deploy full     # Build + deploy complet"
    echo "  ./deploy health   # Check si tout marche"
}

test_ssh() {
    echo -e "${CYAN}📡 Test connexion SSH...${NC}"
    if ssh -i $SSH_KEY $VPS_HOST "echo 'OK'" > /dev/null 2>&1; then
        echo -e "${GREEN}✅ SSH OK${NC}"
        return 0
    else
        echo -e "${RED}❌ SSH KO - Vérifie ta clé${NC}"
        echo "Essaye: ssh -i $SSH_KEY $VPS_HOST"
        return 1
    fi
}

backup_frontpage() {
    echo -e "${CYAN}💾 Backup FRONTPAGE...${NC}"
    BACKUP_DIR="backups/$(date +%Y-%m-%d)"
    mkdir -p "$BACKUP_DIR"
    cp -r FRONTPAGE "$BACKUP_DIR/FRONTPAGE.backup-$(date +%H%M%S)"
    echo -e "${GREEN}✅ Backup dans $BACKUP_DIR${NC}"
}

# ═══════════════════════════════════════════
# DEPLOY LOCAL
# ═══════════════════════════════════════════

deploy_local() {
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    echo -e "${BLUE}    📦 DEPLOY LOCAL${NC}"
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    
    # Build React si nécessaire
    if [ -f "apps/magic-stack-unified/package.json" ]; then
        echo -e "${CYAN}⚛️ Build React...${NC}"
        cd apps/magic-stack-unified
        npm run build
        cd ../..
    fi
    
    echo -e "${GREEN}✅ Deploy local terminé${NC}"
    echo "Ouvre: http://localhost:8000"
}

# ═══════════════════════════════════════════
# DEPLOY VPS (RAPIDE)
# ═══════════════════════════════════════════

deploy_vps() {
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    echo -e "${BLUE}    🚀 DEPLOY VPS RAPIDE${NC}"
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    
    # Test SSH d'abord
    test_ssh || return 1
    
    echo -e "${CYAN}📤 Sync FRONTPAGE...${NC}"
    rsync -avz -e "ssh -i $SSH_KEY" \
        --exclude 'node_modules' \
        --exclude '.git' \
        FRONTPAGE/ $VPS_HOST:$VPS_APP_DIR/FRONTPAGE/
    
    echo -e "${CYAN}📤 Sync HTML files...${NC}"
    rsync -avz -e "ssh -i $SSH_KEY" \
        *.html $VPS_HOST:$VPS_APP_DIR/
    
    echo -e "${GREEN}✅ Deploy VPS terminé!${NC}"
    echo "🌐 Voir: https://$VPS_URL"
}

# ═══════════════════════════════════════════
# DEPLOY FULL (BUILD + DEPLOY)
# ═══════════════════════════════════════════

deploy_full() {
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    echo -e "${BLUE}    🔥 DEPLOY COMPLET${NC}"
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    
    # Test SSH d'abord
    test_ssh || return 1
    
    # Build local
    echo -e "${CYAN}🔨 Build local...${NC}"
    deploy_local
    
    # Deploy VPS
    echo -e "${CYAN}🚀 Deploy sur VPS...${NC}"
    deploy_vps
    
    # Restart services sur VPS
    echo -e "${CYAN}🔄 Restart services VPS...${NC}"
    ssh -i $SSH_KEY $VPS_HOST "systemctl restart caddy magic-java magic-rust magic-vector magic-clippy"
    
    echo -e "${GREEN}✨ Deploy complet terminé!${NC}"
}

# ═══════════════════════════════════════════
# HEALTH CHECK
# ═══════════════════════════════════════════

health_check() {
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    echo -e "${BLUE}    🏥 HEALTH CHECK${NC}"
    echo -e "${BLUE}═══════════════════════════════════${NC}"
    
    # Pages principales
    echo -e "${CYAN}📱 Check pages...${NC}"
    for url in \
        "https://$VPS_URL/" \
        "https://$VPS_URL/FRONTPAGE/" \
        "https://$VPS_URL/HOT_GAME_UNIFIED.html" \
        "https://$VPS_URL/api/health" \
        "https://$VPS_URL/engine/health"
    do
        CODE=$(curl -s -o /dev/null -w "%{http_code}" "$url")
        if [ "$CODE" = "200" ]; then
            echo -e "${GREEN}✅ $CODE${NC} - $url"
        else
            echo -e "${RED}❌ $CODE${NC} - $url"
        fi
    done
}

# ═══════════════════════════════════════════
# MAIN
# ═══════════════════════════════════════════

case "$1" in
    local)
        deploy_local
        ;;
    vps)
        deploy_vps
        ;;
    full)
        deploy_full
        ;;
    health)
        health_check
        ;;
    backup)
        backup_frontpage
        ;;
    help|--help|-h)
        show_usage
        ;;
    *)
        echo -e "${YELLOW}⚠️ Commande inconnue${NC}"
        show_usage
        exit 1
        ;;
esac
