#!/bin/bash

# ğŸš€ DEPLOY - Script de dÃ©ploiement unifiÃ©
# Un seul script pour tout dÃ©ployer proprement

# Couleurs
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
SSH_KEY="~/.ssh/hot_magic_key"
VPS_HOST="root@191.101.2.178"
VPS_URL="heroesoftime.online"
VPS_APP_DIR="/opt/hot/app"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# FONCTIONS HELPER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_usage() {
    echo -e "${CYAN}ğŸš€ DEPLOY - Script de dÃ©ploiement unifiÃ©${NC}"
    echo ""
    echo "Usage: ./deploy [command]"
    echo ""
    echo "Commands:"
    echo "  local     - DÃ©ployer en local seulement"
    echo "  vps       - DÃ©ployer sur le VPS (rapide)"
    echo "  full      - Build + deploy complet"
    echo "  health    - VÃ©rifier santÃ© du VPS"
    echo "  backup    - Sauvegarder avant deploy"
    echo "  help      - Afficher cette aide"
    echo ""
    echo "Exemples:"
    echo "  ./deploy vps      # Deploy rapide sur VPS"
    echo "  ./deploy full     # Build + deploy complet"
    echo "  ./deploy health   # Check si tout marche"
}

test_ssh() {
    echo -e "${CYAN}ğŸ“¡ Test connexion SSH...${NC}"
    if ssh -i $SSH_KEY $VPS_HOST "echo 'OK'" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… SSH OK${NC}"
        return 0
    else
        echo -e "${RED}âŒ SSH KO - VÃ©rifie ta clÃ©${NC}"
        echo "Essaye: ssh -i $SSH_KEY $VPS_HOST"
        return 1
    fi
}

backup_frontpage() {
    echo -e "${CYAN}ğŸ’¾ Backup FRONTPAGE...${NC}"
    BACKUP_DIR="backups/$(date +%Y-%m-%d)"
    mkdir -p "$BACKUP_DIR"
    cp -r FRONTPAGE "$BACKUP_DIR/FRONTPAGE.backup-$(date +%H%M%S)"
    echo -e "${GREEN}âœ… Backup dans $BACKUP_DIR${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPLOY LOCAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deploy_local() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}    ğŸ“¦ DEPLOY LOCAL${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # Build React si nÃ©cessaire
    if [ -f "apps/magic-stack-unified/package.json" ]; then
        echo -e "${CYAN}âš›ï¸ Build React...${NC}"
        cd apps/magic-stack-unified
        npm run build
        cd ../..
    fi
    
    echo -e "${GREEN}âœ… Deploy local terminÃ©${NC}"
    echo "Ouvre: http://localhost:8000"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPLOY VPS (RAPIDE)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deploy_vps() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}    ğŸš€ DEPLOY VPS RAPIDE${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # Test SSH d'abord
    test_ssh || return 1
    
    echo -e "${CYAN}ğŸ“¤ Sync FRONTPAGE...${NC}"
    rsync -avz -e "ssh -i $SSH_KEY" \
        --exclude 'node_modules' \
        --exclude '.git' \
        FRONTPAGE/ $VPS_HOST:$VPS_APP_DIR/FRONTPAGE/
    
    echo -e "${CYAN}ğŸ“¤ Sync HTML files...${NC}"
    rsync -avz -e "ssh -i $SSH_KEY" \
        *.html $VPS_HOST:$VPS_APP_DIR/
    
    echo -e "${GREEN}âœ… Deploy VPS terminÃ©!${NC}"
    echo "ğŸŒ Voir: https://$VPS_URL"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPLOY FULL (BUILD + DEPLOY)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

deploy_full() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}    ğŸ”¥ DEPLOY COMPLET${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # Test SSH d'abord
    test_ssh || return 1
    
    # Build local
    echo -e "${CYAN}ğŸ”¨ Build local...${NC}"
    deploy_local
    
    # Deploy VPS
    echo -e "${CYAN}ğŸš€ Deploy sur VPS...${NC}"
    deploy_vps
    
    # Restart services sur VPS
    echo -e "${CYAN}ğŸ”„ Restart services VPS...${NC}"
    ssh -i $SSH_KEY $VPS_HOST "systemctl restart caddy magic-java magic-rust magic-vector magic-clippy"
    
    echo -e "${GREEN}âœ¨ Deploy complet terminÃ©!${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HEALTH CHECK
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

health_check() {
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}    ğŸ¥ HEALTH CHECK${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # Pages principales
    echo -e "${CYAN}ğŸ“± Check pages...${NC}"
    for url in \
        "https://$VPS_URL/" \
        "https://$VPS_URL/FRONTPAGE/" \
        "https://$VPS_URL/HOT_GAME_UNIFIED.html" \
        "https://$VPS_URL/api/health" \
        "https://$VPS_URL/engine/health"
    do
        CODE=$(curl -s -o /dev/null -w "%{http_code}" "$url")
        if [ "$CODE" = "200" ]; then
            echo -e "${GREEN}âœ… $CODE${NC} - $url"
        else
            echo -e "${RED}âŒ $CODE${NC} - $url"
        fi
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

case "$1" in
    local)
        deploy_local
        ;;
    vps)
        deploy_vps
        ;;
    full)
        deploy_full
        ;;
    health)
        health_check
        ;;
    backup)
        backup_frontpage
        ;;
    help|--help|-h)
        show_usage
        ;;
    *)
        echo -e "${YELLOW}âš ï¸ Commande inconnue${NC}"
        show_usage
        exit 1
        ;;
esac
