<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>üé® Extracteur de Tiles - LOUMEN</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #FFD700;
            text-shadow: 0 0 20px #FF6600;
        }
        
        .controls {
            background: rgba(0,0,0,0.8);
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-row {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background: #8B4513;
            border: 2px solid #FFD700;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button:hover {
            background: #A0522D;
        }
        
        input[type="number"] {
            width: 80px;
            padding: 5px;
            background: #333;
            border: 1px solid #666;
            color: white;
        }
        
        input[type="file"] {
            padding: 10px;
            background: #333;
            border: 1px solid #666;
            color: white;
            border-radius: 5px;
        }
        
        .workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .canvas-container {
            background: #222;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 10px;
            position: relative;
            overflow: auto;
            max-height: 600px;
        }
        
        canvas {
            background: #000;
            cursor: crosshair;
        }
        
        .tiles-panel {
            background: rgba(0,0,0,0.8);
            border: 2px solid #00D9FF;
            border-radius: 10px;
            padding: 10px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .tile-preview {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border: 1px solid #666;
            border-radius: 5px;
            text-align: center;
        }
        
        .tile-preview canvas {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tile-preview canvas:hover {
            border-color: #FFD700;
            transform: scale(1.1);
        }
        
        .grid-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            pointer-events: none;
        }
        
        .info {
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .export-btn {
            background: #228B22;
            font-size: 18px;
            padding: 15px 30px;
            margin: 20px 0;
        }
        
        .export-btn:hover {
            background: #32CD32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Extracteur de Tiles Isom√©triques</h1>
        
        <div class="controls">
            <div class="control-row">
                <label>üìÅ Charger une image :</label>
                <input type="file" id="imageInput" accept="image/*">
                <button onclick="loadDefaultImage()">üñºÔ∏è Charger MAP ISO.png</button>
            </div>
            
            <div class="control-row">
                <label>üìê Taille des tiles :</label>
                <label>Largeur: <input type="number" id="tileWidth" value="64" min="16" max="256"></label>
                <label>Hauteur: <input type="number" id="tileHeight" value="32" min="16" max="256"></label>
                <button onclick="updateGrid()">üîÑ Mettre √† jour la grille</button>
            </div>
            
            <div class="control-row">
                <label>üéØ Mode :</label>
                <button onclick="setMode('rect')" id="modeRect">üì¶ Rectangle</button>
                <button onclick="setMode('hex')" id="modeHex">‚¨° Hexagonal</button>
                <button onclick="setMode('iso')" id="modeIso">üíé Isom√©trique</button>
            </div>
            
            <div class="control-row">
                <button onclick="extractAllTiles()">‚ö° Extraire toutes les tiles</button>
                <button onclick="clearTiles()">üóëÔ∏è Effacer</button>
                <button class="export-btn" onclick="exportTiles()">üíæ Exporter les Tiles</button>
            </div>
        </div>
        
        <div class="workspace">
            <div class="canvas-container">
                <canvas id="mainCanvas"></canvas>
                <canvas id="gridCanvas" class="grid-overlay"></canvas>
            </div>
            
            <div class="tiles-panel">
                <h3 style="text-align: center; color: #00D9FF;">üì¶ Tiles Extraites</h3>
                <div class="info">
                    <div>Total: <span id="tileCount">0</span> tiles</div>
                    <div>Clic pour s√©lectionner</div>
                    <div>Double-clic pour exporter</div>
                </div>
                <div id="tilesContainer"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const config = {
            tileWidth: 64,
            tileHeight: 32,
            mode: 'iso', // rect, hex, iso
            tiles: [],
            currentImage: null
        };
        
        // Canvas
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const gridCanvas = document.getElementById('gridCanvas');
        const gridCtx = gridCanvas.getContext('2d');
        
        // Charger une image
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    loadImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
        
        function loadImage(src) {
            const img = new Image();
            img.onload = () => {
                config.currentImage = img;
                mainCanvas.width = img.width;
                mainCanvas.height = img.height;
                gridCanvas.width = img.width;
                gridCanvas.height = img.height;
                mainCtx.drawImage(img, 0, 0);
                updateGrid();
            };
            img.src = src;
        }
        
        // Charger l'image par d√©faut
        function loadDefaultImage() {
            loadImage('../assets/IMAGES_VINCENT/MAP ISO.png');
        }
        
        // Mettre √† jour la grille
        function updateGrid() {
            config.tileWidth = parseInt(document.getElementById('tileWidth').value);
            config.tileHeight = parseInt(document.getElementById('tileHeight').value);
            
            gridCtx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
            gridCtx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
            gridCtx.lineWidth = 1;
            
            switch (config.mode) {
                case 'rect':
                    drawRectGrid();
                    break;
                case 'hex':
                    drawHexGrid();
                    break;
                case 'iso':
                    drawIsoGrid();
                    break;
            }
        }
        
        // Grille rectangulaire
        function drawRectGrid() {
            for (let x = 0; x < gridCanvas.width; x += config.tileWidth) {
                gridCtx.beginPath();
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, gridCanvas.height);
                gridCtx.stroke();
            }
            
            for (let y = 0; y < gridCanvas.height; y += config.tileHeight) {
                gridCtx.beginPath();
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(gridCanvas.width, y);
                gridCtx.stroke();
            }
        }
        
        // Grille hexagonale
        function drawHexGrid() {
            const hexHeight = config.tileHeight;
            const hexWidth = config.tileWidth;
            const hexSide = hexHeight / 2;
            
            for (let row = 0; row < gridCanvas.height / hexHeight + 1; row++) {
                for (let col = 0; col < gridCanvas.width / hexWidth + 1; col++) {
                    const x = col * hexWidth + (row % 2 ? hexWidth / 2 : 0);
                    const y = row * hexHeight * 0.75;
                    
                    drawHexagon(x, y, hexWidth / 2);
                }
            }
        }
        
        function drawHexagon(cx, cy, size) {
            gridCtx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i;
                const x = cx + size * Math.cos(angle);
                const y = cy + size * Math.sin(angle);
                if (i === 0) gridCtx.moveTo(x, y);
                else gridCtx.lineTo(x, y);
            }
            gridCtx.closePath();
            gridCtx.stroke();
        }
        
        // Grille isom√©trique
        function drawIsoGrid() {
            const tileWidth = config.tileWidth;
            const tileHeight = config.tileHeight;
            
            // Lignes diagonales descendantes (/)
            for (let i = -gridCanvas.height; i < gridCanvas.width + gridCanvas.height; i += tileWidth) {
                gridCtx.beginPath();
                gridCtx.moveTo(i, 0);
                gridCtx.lineTo(i + gridCanvas.height * 2, gridCanvas.height);
                gridCtx.stroke();
            }
            
            // Lignes diagonales montantes (\)
            for (let i = -gridCanvas.height; i < gridCanvas.width + gridCanvas.height; i += tileWidth) {
                gridCtx.beginPath();
                gridCtx.moveTo(i, gridCanvas.height);
                gridCtx.lineTo(i + gridCanvas.height * 2, 0);
                gridCtx.stroke();
            }
        }
        
        // Changer de mode
        function setMode(mode) {
            config.mode = mode;
            
            // Mettre √† jour les boutons
            document.getElementById('modeRect').style.background = mode === 'rect' ? '#FFD700' : '#8B4513';
            document.getElementById('modeHex').style.background = mode === 'hex' ? '#FFD700' : '#8B4513';
            document.getElementById('modeIso').style.background = mode === 'iso' ? '#FFD700' : '#8B4513';
            
            // Ajuster les dimensions par d√©faut selon le mode
            if (mode === 'iso') {
                document.getElementById('tileWidth').value = 64;
                document.getElementById('tileHeight').value = 32;
            } else if (mode === 'hex') {
                document.getElementById('tileWidth').value = 56;
                document.getElementById('tileHeight').value = 64;
            } else {
                document.getElementById('tileWidth').value = 32;
                document.getElementById('tileHeight').value = 32;
            }
            
            updateGrid();
        }
        
        // Extraire une tile
        function extractTile(x, y) {
            if (!config.currentImage) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = config.tileWidth;
            canvas.height = config.tileHeight;
            const ctx = canvas.getContext('2d');
            
            // Pour le mode iso, ajuster l'extraction
            if (config.mode === 'iso') {
                // Dessiner un masque en losange
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2, 0);
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.lineTo(canvas.width / 2, canvas.height);
                ctx.lineTo(0, canvas.height / 2);
                ctx.closePath();
                ctx.clip();
            }
            
            ctx.drawImage(
                config.currentImage,
                x, y,
                config.tileWidth, config.tileHeight,
                0, 0,
                config.tileWidth, config.tileHeight
            );
            
            if (config.mode === 'iso') {
                ctx.restore();
            }
            
            return canvas;
        }
        
        // Extraire toutes les tiles
        function extractAllTiles() {
            if (!config.currentImage) {
                alert('Chargez d\'abord une image !');
                return;
            }
            
            config.tiles = [];
            const container = document.getElementById('tilesContainer');
            container.innerHTML = '';
            
            const cols = Math.floor(mainCanvas.width / config.tileWidth);
            const rows = Math.floor(mainCanvas.height / config.tileHeight);
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = col * config.tileWidth;
                    const y = row * config.tileHeight;
                    
                    const tileCanvas = extractTile(x, y);
                    config.tiles.push({
                        canvas: tileCanvas,
                        x: x,
                        y: y,
                        index: config.tiles.length
                    });
                    
                    // Cr√©er la preview
                    const preview = document.createElement('div');
                    preview.className = 'tile-preview';
                    preview.innerHTML = `
                        <div>Tile ${config.tiles.length}</div>
                        <div style="font-size: 12px; color: #888;">
                            ${x},${y} ‚Üí ${x + config.tileWidth},${y + config.tileHeight}
                        </div>
                    `;
                    
                    const previewCanvas = document.createElement('canvas');
                    previewCanvas.width = config.tileWidth;
                    previewCanvas.height = config.tileHeight;
                    const previewCtx = previewCanvas.getContext('2d');
                    previewCtx.drawImage(tileCanvas, 0, 0);
                    
                    preview.appendChild(previewCanvas);
                    container.appendChild(preview);
                    
                    // Double-clic pour exporter individuellement
                    previewCanvas.addEventListener('dblclick', () => {
                        exportSingleTile(config.tiles.length - 1);
                    });
                }
            }
            
            document.getElementById('tileCount').textContent = config.tiles.length;
        }
        
        // Clic sur le canvas principal
        mainCanvas.addEventListener('click', (e) => {
            const rect = mainCanvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / config.tileWidth) * config.tileWidth;
            const y = Math.floor((e.clientY - rect.top) / config.tileHeight) * config.tileHeight;
            
            const tileCanvas = extractTile(x, y);
            config.tiles.push({
                canvas: tileCanvas,
                x: x,
                y: y,
                index: config.tiles.length
            });
            
            // Ajouter √† la liste
            const container = document.getElementById('tilesContainer');
            const preview = document.createElement('div');
            preview.className = 'tile-preview';
            preview.innerHTML = `
                <div>Tile ${config.tiles.length}</div>
                <div style="font-size: 12px; color: #888;">${x},${y}</div>
            `;
            
            const previewCanvas = document.createElement('canvas');
            previewCanvas.width = config.tileWidth;
            previewCanvas.height = config.tileHeight;
            const previewCtx = previewCanvas.getContext('2d');
            previewCtx.drawImage(tileCanvas, 0, 0);
            
            preview.appendChild(previewCanvas);
            container.appendChild(preview);
            
            document.getElementById('tileCount').textContent = config.tiles.length;
        });
        
        // Effacer les tiles
        function clearTiles() {
            config.tiles = [];
            document.getElementById('tilesContainer').innerHTML = '';
            document.getElementById('tileCount').textContent = '0';
        }
        
        // Exporter une tile
        function exportSingleTile(index) {
            const tile = config.tiles[index];
            const link = document.createElement('a');
            link.download = `tile_${config.mode}_${index + 1}.png`;
            link.href = tile.canvas.toDataURL();
            link.click();
        }
        
        // Exporter toutes les tiles
        function exportTiles() {
            if (config.tiles.length === 0) {
                alert('Aucune tile √† exporter !');
                return;
            }
            
            // Cr√©er un zip si possible, sinon exporter une par une
            config.tiles.forEach((tile, index) => {
                setTimeout(() => {
                    exportSingleTile(index);
                }, index * 100); // D√©lai pour √©viter le blocage du navigateur
            });
        }
        
        // Initialiser
        setMode('iso');
        
        // Message d'accueil
        console.log('üé® Extracteur de Tiles pr√™t !');
        console.log('Par LOUMEN pour REALGAME');
    </script>
</body>
</html>