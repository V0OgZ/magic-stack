<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6D Parity Test - HTML vs React Core</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: monospace; 
            background: #0a0e27; 
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-panel {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 10px;
        }
        
        .test-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status.pass {
            background: #10b981;
            color: #fff;
        }
        
        .status.fail {
            background: #ef4444;
            color: #fff;
        }
        
        .status.pending {
            background: #6b7280;
            color: #fff;
        }
        
        pre {
            background: #0a0e27;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.85em;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        .diff {
            background: #fbbf24;
            color: #000;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>6D Core Parity Test</h1>
        <p>Testing event replay consistency between HTML and React cores</p>
        
        <div>
            <button onclick="runTest('scenario1')">Test Scenario 1 (Hero Movement)</button>
            <button onclick="runTest('scenario2')">Test Scenario 2 (Portal Collapse)</button>
            <button onclick="runTest('scenario3')">Test Scenario 3 (Buff Chain)</button>
            <button onclick="runAllTests()">Run All Tests</button>
        </div>
        
        <div class="test-grid">
            <div class="test-panel">
                <h3>HTML Core (Local)</h3>
                <div id="htmlStatus" class="status pending">Waiting...</div>
                <pre id="htmlState"></pre>
            </div>
            
            <div class="test-panel">
                <h3>React Core (Expected)</h3>
                <div id="reactStatus" class="status pending">Waiting...</div>
                <pre id="reactState"></pre>
            </div>
        </div>
        
        <div class="test-panel" style="margin-top: 20px;">
            <h3>Test Results</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        // HTML Core implementation (same as in MAP_EDITOR_6D_ADAPTER.html)
        class Position6D {
            constructor(x = 0, y = 0, z = 0, t = 0, psi = 0, sigma = 0) {
                this.x = x;
                this.y = y;
                this.z = z;
                this.t = t;
                this.psi = psi;
                this.sigma = sigma;
            }
        }
        
        class CoreStore {
            constructor() {
                this.state = {
                    version: '1.1',
                    entities: {},
                    clock: new Position6D()
                };
                this.log = [];
                this.subscribers = new Set();
            }
            
            getState() {
                return this.state;
            }
            
            dispatch(event) {
                const ts = Date.now();
                this.log.push({ ts, event });
                
                // Apply event to state
                switch(event.type) {
                    case 'move6d':
                        if (this.state.entities[event.entityId]) {
                            const entity = this.state.entities[event.entityId];
                            Object.assign(entity.pos, event.delta);
                        }
                        break;
                    case 'add':
                        this.state.entities[event.entity.id] = event.entity;
                        break;
                    case 'remove':
                        delete this.state.entities[event.entityId];
                        break;
                    case 'collapse':
                        delete this.state.entities[event.targetId];
                        break;
                    case 'artifactApplied':
                        if (this.state.entities[event.entityId]) {
                            const entity = this.state.entities[event.entityId];
                            if (!entity.modifiers) entity.modifiers = {};
                            entity.modifiers[event.modifier.key] = event.modifier.factor;
                        }
                        break;
                }
                
                // Notify subscribers
                this.subscribers.forEach(fn => fn(event, this.state));
                
                return event;
            }
            
            replay(events) {
                this.state = {
                    version: '1.1',
                    entities: {},
                    clock: new Position6D()
                };
                this.log = [];
                events.forEach(entry => {
                    this.dispatch(entry.event || entry);
                });
            }
        }
        
        // Test scenarios
        const scenarios = {
            scenario1: [
                {"type":"add","entity":{"id":"hero_1","type":"hero","name":"Hero 1","pos":{"x":100,"y":100,"z":0,"t":1000,"psi":0,"sigma":0},"amplitude":10}},
                {"type":"move6d","entityId":"hero_1","delta":{"x":150,"y":100}},
                {"type":"move6d","entityId":"hero_1","delta":{"x":200,"y":150}},
                {"type":"move6d","entityId":"hero_1","delta":{"x":250,"y":200,"z":1}},
                {"type":"move6d","entityId":"hero_1","delta":{"t":2000,"psi":1.57}}
            ],
            scenario2: [
                {"type":"add","entity":{"id":"portal_1","type":"portal","state":"stable","pos":{"x":300,"y":300,"z":0,"t":1000,"psi":0.785,"sigma":0}}},
                {"type":"add","entity":{"id":"portal_2","type":"portal","state":"unstable","pos":{"x":400,"y":300,"z":0,"t":1000,"psi":2.356,"sigma":0}}},
                {"type":"add","entity":{"id":"hero_1","type":"hero","name":"Hero 1","pos":{"x":100,"y":100,"z":0,"t":1000,"psi":0,"sigma":0},"amplitude":10}},
                {"type":"move6d","entityId":"hero_1","delta":{"x":300,"y":300}},
                {"type":"collapse","targetId":"portal_2","reason":"decay"},
                {"type":"artifactApplied","entityId":"hero_1","modifier":{"key":"speed","factor":1.5}}
            ],
            scenario3: [
                {"type":"add","entity":{"id":"buff_1","type":"buff","kind":"speed","level":1,"pos":{"x":200,"y":200,"z":0,"t":1000,"psi":0,"sigma":1}}},
                {"type":"add","entity":{"id":"buff_2","type":"buff","kind":"power","level":2,"pos":{"x":250,"y":200,"z":0,"t":1000,"psi":0,"sigma":2}}},
                {"type":"add","entity":{"id":"hero_1","type":"hero","name":"Hero 1","pos":{"x":100,"y":200,"z":0,"t":1000,"psi":0,"sigma":0},"amplitude":10}},
                {"type":"move6d","entityId":"hero_1","delta":{"x":200,"y":200}},
                {"type":"artifactApplied","entityId":"hero_1","modifier":{"key":"speed","factor":1.5}},
                {"type":"move6d","entityId":"hero_1","delta":{"x":250,"y":200}},
                {"type":"artifactApplied","entityId":"hero_1","modifier":{"key":"power","factor":2.0}},
                {"type":"collapse","targetId":"buff_1","reason":"tie-break"},
                {"type":"collapse","targetId":"buff_2","reason":"tie-break"},
                {"type":"move6d","entityId":"hero_1","delta":{"z":2,"sigma":3}}
            ]
        };
        
        // Expected final states (snapshots from React core)
        const expectedStates = {
            scenario1: {
                entities: {
                    hero_1: {
                        id: "hero_1",
                        type: "hero",
                        name: "Hero 1",
                        pos: { x: 250, y: 200, z: 1, t: 2000, psi: 1.57, sigma: 0 },
                        amplitude: 10
                    }
                }
            },
            scenario2: {
                entities: {
                    portal_1: {
                        id: "portal_1",
                        type: "portal",
                        state: "stable",
                        pos: { x: 300, y: 300, z: 0, t: 1000, psi: 0.785, sigma: 0 }
                    },
                    hero_1: {
                        id: "hero_1",
                        type: "hero",
                        name: "Hero 1",
                        pos: { x: 300, y: 300, z: 0, t: 1000, psi: 0, sigma: 0 },
                        amplitude: 10,
                        modifiers: { speed: 1.5 }
                    }
                }
            },
            scenario3: {
                entities: {
                    hero_1: {
                        id: "hero_1",
                        type: "hero",
                        name: "Hero 1",
                        pos: { x: 250, y: 200, z: 2, t: 1000, psi: 0, sigma: 3 },
                        amplitude: 10,
                        modifiers: { speed: 1.5, power: 2.0 }
                    }
                }
            }
        };
        
        function compareStates(actual, expected) {
            const actualStr = JSON.stringify(actual.entities, null, 2);
            const expectedStr = JSON.stringify(expected.entities, null, 2);
            return {
                match: actualStr === expectedStr,
                actualStr,
                expectedStr
            };
        }
        
        function runTest(scenarioName) {
            const events = scenarios[scenarioName];
            const expected = expectedStates[scenarioName];
            
            // Run HTML core
            const htmlCore = new CoreStore();
            htmlCore.replay(events);
            const htmlState = htmlCore.getState();
            
            // Compare
            const result = compareStates(htmlState, expected);
            
            // Update UI
            document.getElementById('htmlState').textContent = result.actualStr;
            document.getElementById('reactState').textContent = result.expectedStr;
            
            const htmlStatus = document.getElementById('htmlStatus');
            const reactStatus = document.getElementById('reactStatus');
            
            if (result.match) {
                htmlStatus.className = 'status pass';
                htmlStatus.textContent = '✓ State matches';
                reactStatus.className = 'status pass';
                reactStatus.textContent = '✓ Expected state';
            } else {
                htmlStatus.className = 'status fail';
                htmlStatus.textContent = '✗ State mismatch';
                reactStatus.className = 'status fail';
                reactStatus.textContent = '✗ Check differences';
            }
            
            // Log results
            const resultsDiv = document.getElementById('testResults');
            const resultEntry = document.createElement('div');
            resultEntry.className = result.match ? 'status pass' : 'status fail';
            resultEntry.textContent = `${scenarioName}: ${result.match ? 'PASS' : 'FAIL'} - ${events.length} events replayed`;
            resultsDiv.appendChild(resultEntry);
        }
        
        function runAllTests() {
            document.getElementById('testResults').innerHTML = '';
            Object.keys(scenarios).forEach(scenario => {
                runTest(scenario);
            });
        }
    </script>
</body>
</html>
